services:
  avatar-backend:
    build:
      context: ..
      dockerfile: backend/docker/Dockerfile
    container_name: avatar-gen-backend
    expose:
      - '3000'
    volumes:
      - ../backend/storage:/app/storage
      - ../backend/settings.yaml:/app/settings.yaml:ro
      - ../backend/settings.production.yaml:/app/settings.production.yaml:ro
      - ../backend/logs:/app/logs
    environment:
      - NODE_ENV=${NODE_ENV:-production}
    dns:
      - 8.8.8.8
      - 8.8.4.4
      - 1.1.1.1
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/api/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - internal
      - backend-db
      - backend-cache

  avatar-frontend:
    build:
      context: ..
      dockerfile: frontend/docker/Dockerfile
    container_name: avatar-gen-frontend
    expose:
      - '8080'
    volumes:
      - ../frontend/logs:/var/log/nginx
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8080/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - internal

networks:
  internal:
    external: true
    name: avatar-gen-internal

  backend-db:
    external: true
    name: avatar-gen-backend-db

  backend-cache:
    external: true
    name: avatar-gen-backend-cache
