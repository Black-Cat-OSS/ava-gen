#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Ç–µ–≥–∞ –∏–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–∞
TAG_NAME="$1"

echo "üè∑Ô∏è  –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–≥–∞: $TAG_NAME"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–µ–≥ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–µ—Ä—Å–∏—é (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 'v')
if [[ "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
  echo "‚úÖ –í–∞–ª–∏–¥–Ω—ã–π —Ç–µ–≥ –≤–µ—Ä—Å–∏–∏: $TAG_NAME"
  
  # –ò–∑–≤–ª–µ–∫–∞–µ–º –≤–µ—Ä—Å–∏—é –∏–∑ —Ç–µ–≥–∞ (—É–±–∏—Ä–∞–µ–º 'v')
  VERSION="${TAG_NAME#v}"
  
  echo "üìù –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ –≤ package.json –¥–æ $VERSION"
  
  # –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Ä—Å–∏—é –≤ package.json
  npm version "$VERSION" --no-git-tag-version --allow-same-version
  
  echo "üìã –ì–µ–Ω–µ—Ä–∞—Ü–∏—è changelog –¥–ª—è –≤–µ—Ä—Å–∏–∏ $VERSION"
  
  # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º changelog —Å –Ω—É–ª—è
  pnpm run changelog:all
  
  echo "üíæ –ö–æ–º–º–∏—Ç–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–µ—Ä—Å–∏–∏ –∏ changelog"
  
  # –ö–æ–º–º–∏—Ç–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
  git add package.json CHANGELOG.md
  git commit -m "chore: Update version to $VERSION and regenerate changelog" || true
  
  echo "üéâ –¢–µ–≥ $TAG_NAME —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω!"
else
  echo "‚ÑπÔ∏è  –¢–µ–≥ $TAG_NAME –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –≤–µ—Ä—Å–∏–æ–Ω–Ω—ã–º, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É"
fi
