# CI/CD Workflows Strategy

**–î–∞—Ç–∞:** 2025-10-05  
**–í–µ—Ä—Å–∏—è:** 3.0 (–ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ Issue #17)

## üéØ –û–±–∑–æ—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **2 –æ—Å–Ω–æ–≤–Ω—ã—Ö workflow** –¥–ª—è –ø–æ–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
–∏ –¥–µ–ø–ª–æ—è:

1. **CI (Develop)** - –±—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è feature/fix –≤–µ—Ç–æ–∫
2. **Production Deploy Pipeline** - –ø–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–µ–ø–ª–æ–π –¥–ª—è main

## üìä –°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã workflows

```
feature/fix branch
      ‚îÇ
      ‚îú‚îÄ PR ‚Üí develop
      ‚îÇ    ‚îî‚îÄ CI (Develop) ‚úì
      ‚îÇ       ‚îú‚îÄ Lint (backend + frontend)
      ‚îÇ       ‚îú‚îÄ Test Backend (SQLite only: 2 –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏)
      ‚îÇ       ‚îú‚îÄ Build Frontend
      ‚îÇ       ‚îî‚îÄ Docker Build Test
      ‚îÇ
      ‚îú‚îÄ Merge ‚Üí develop
      ‚îÇ    ‚îî‚îÄ (–ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Å—Ç–æ–≤)
      ‚îÇ
develop branch
      ‚îÇ
      ‚îú‚îÄ PR ‚Üí main
      ‚îÇ    ‚îî‚îÄ Production Deploy Pipeline ‚úì
      ‚îÇ       ‚îú‚îÄ Test Backend (FULL: 4 –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏)
      ‚îÇ       ‚îú‚îÄ Build Frontend
      ‚îÇ       ‚îú‚îÄ Docker Images Build
      ‚îÇ       ‚îú‚îÄ Integration Tests
      ‚îÇ       ‚îî‚îÄ Deploy: SKIP (—Ç–æ–ª—å–∫–æ –Ω–∞ PR)
      ‚îÇ
      ‚îú‚îÄ Merge ‚Üí main
      ‚îÇ    ‚îî‚îÄ Production Deploy Pipeline ‚úì‚úì
      ‚îÇ       ‚îú‚îÄ Test Backend (FULL: 4 –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏)
      ‚îÇ       ‚îú‚îÄ Build Frontend
      ‚îÇ       ‚îú‚îÄ Docker Images Build
      ‚îÇ       ‚îú‚îÄ Integration Tests
      ‚îÇ       ‚îî‚îÄ Deploy: RUN (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π)
      ‚îÇ
main branch
      ‚îÇ
      ‚îî‚îÄ Production Server üöÄ
```

## üîÑ –°—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 1. –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ feature/fix ‚Üí develop

**Workflow:** `CI (Develop)`

**–¢—Ä–∏–≥–≥–µ—Ä:**

```yaml
on:
  pull_request:
    branches: [develop]
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

- ‚úÖ –õ–∏–Ω—Ç–∏–Ω–≥ backend + frontend
- ‚úÖ –ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã (SQLite + Local, SQLite + S3)
- ‚úÖ –°–±–æ—Ä–∫–∞ frontend
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∫–∏ Docker –æ–±—Ä–∞–∑–æ–≤

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~5-7 –º–∏–Ω—É—Ç

**–¶–µ–ª—å:** –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –ø–µ—Ä–µ–¥ –º–µ—Ä–¥–∂–µ–º –≤ develop

---

### 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä–µ–ª–∏–∑–∞: develop ‚Üí main (PR)

**Workflow:** `Production Deploy Pipeline`

**–¢—Ä–∏–≥–≥–µ—Ä:**

```yaml
on:
  pull_request:
    branches: [main]
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

- ‚úÖ –ü–æ–ª–Ω—ã–µ —Ç–µ—Å—Ç—ã (SQLite + PostgreSQL) √ó (Local + S3) = 4 –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
- ‚úÖ –°–±–æ—Ä–∫–∞ frontend —Å artifacts
- ‚úÖ –°–±–æ—Ä–∫–∞ –≤—Å–µ—Ö Docker –æ–±—Ä–∞–∑–æ–≤
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (Docker Compose)
- ‚ùå **–ë–ï–ó –¥–µ–ø–ª–æ—è** (—Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏)

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~10-15 –º–∏–Ω—É—Ç

**–¶–µ–ª—å:** –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –∫–æ–¥ –≥–æ—Ç–æ–≤ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É –ø–µ—Ä–µ–¥ –º–µ—Ä–¥–∂–µ–º

---

### 3. –î–µ–ø–ª–æ–π –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω: main (–ø–æ—Å–ª–µ –º–µ—Ä–¥–∂–∞)

**Workflow:** `Production Deploy Pipeline`

**–¢—Ä–∏–≥–≥–µ—Ä:**

```yaml
on:
  push:
    branches: [main]
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**

- ‚úÖ –ü–æ–ª–Ω—ã–µ —Ç–µ—Å—Ç—ã (4 –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏)
- ‚úÖ –°–±–æ—Ä–∫–∞ frontend
- ‚úÖ –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
- ‚úÖ **–ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –î–ï–ü–õ–û–ô** –Ω–∞ production —Å–µ—Ä–≤–µ—Ä

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~15-20 –º–∏–Ω—É—Ç

**–¶–µ–ª—å:** –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ + –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π

---

## üìã –î–µ—Ç–∞–ª–∏ workflows

### CI (Develop) - `.github/workflows/ci.yml`

**Jobs:**

| Job                 | –û–ø–∏—Å–∞–Ω–∏–µ                      | –í—Ä–µ–º—è    |
| ------------------- | ----------------------------- | -------- |
| `lint-backend`      | ESLint –ø—Ä–æ–≤–µ—Ä–∫–∞ backend –∫–æ–¥–∞  | ~1 –º–∏–Ω   |
| `lint-frontend`     | ESLint –ø—Ä–æ–≤–µ—Ä–∫–∞ frontend –∫–æ–¥–∞ | ~1 –º–∏–Ω   |
| `test-backend`      | Unit + E2E —Ç–µ—Å—Ç—ã (SQLite √ó 2) | ~3-4 –º–∏–Ω |
| `build-frontend`    | Vite —Å–±–æ—Ä–∫–∞ React –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è  | ~1-2 –º–∏–Ω |
| `docker-build-test` | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∫–∏ –æ–±—Ä–∞–∑–æ–≤       | ~2-3 –º–∏–Ω |

**–ú–∞—Ç—Ä–∏—Ü–∞ —Ç–µ—Å—Ç–æ–≤:**

- SQLite + Local Storage
- SQLite + S3 Storage

**–ü–æ—á–µ–º—É —Ç–æ–ª—å–∫–æ SQLite:**

- –ë—ã—Å—Ç—Ä–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
- PostgreSQL —Ç–µ—Å—Ç—ã –≤ PR –≤ main (–ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–æ–º)
- –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –±–∞–≥–æ–≤ –ª–æ–≤—è—Ç—Å—è –Ω–∞ SQLite

---

### Production Deploy Pipeline - `.github/workflows/deploy-prod.yml`

**5 Stages:**

#### Stage 1: Unit & E2E Tests

**–ú–∞—Ç—Ä–∏—Ü–∞ (4 –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏):**

- SQLite + Local Storage
- SQLite + S3 Storage
- PostgreSQL + Local Storage _(–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–µ—Å—Ç–æ–≤)_
- PostgreSQL + S3 Storage _(–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–µ—Å—Ç–æ–≤)_

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** PostgreSQL –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

#### Stage 2: Build Frontend

- Vite —Å–±–æ—Ä–∫–∞
- Upload artifacts

#### Stage 3: Docker Images Build

- Backend image
- Frontend image
- Gateway image
- GitHub Actions cache

#### Stage 4: Integration Tests

- Docker Compose –∑–∞–ø—É—Å–∫
- Health checks (backend, frontend, gateway)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –≤–º–µ—Å—Ç–µ

#### Stage 5: Production Deployment

- **–£—Å–ª–æ–≤–∏–µ:** –¢–æ–ª—å–∫–æ –ø—Ä–∏ `push` –≤ main
- SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
- Git pull
- Docker build (–±–µ–∑ –ø—Ä–æ—Ñ–∏–ª—è - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–Ω–µ—à–Ω—é—é PostgreSQL)
- Docker up
- Health checks

---

## üö´ –ß—Ç–æ –ù–ï –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

### –ü—Ä–∏ PR –≤ develop:

- ‚ùå PostgreSQL —Ç–µ—Å—Ç—ã (—Ç–æ–ª—å–∫–æ SQLite)
- ‚ùå –ü–æ–ª–Ω–∞—è –º–∞—Ç—Ä–∏—Ü–∞
- ‚ùå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

### –ü—Ä–∏ push –≤ develop:

- ‚ùå –í–æ–æ–±—â–µ –Ω–∏—á–µ–≥–æ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è (–∫–æ–¥ —É–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω –≤ PR)

### –ü—Ä–∏ PR –≤ main:

- ‚ùå –î–µ–ø–ª–æ–π (—Ç–æ–ª—å–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)

## ‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –£–±—Ä–∞–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ:

**–î–æ (–ø—Ä–æ–±–ª–µ–º—ã):**

```
PR –≤ develop:
  ‚îú‚îÄ ci.yml (—Ç–µ—Å—Ç—ã)
  ‚îî‚îÄ test-matrix-full.yml (—Ç–µ—Å—Ç—ã) ‚Üê –î–£–ë–õ–ò–ö–ê–¢

Push –≤ develop:
  ‚îî‚îÄ ci.yml (—Ç–µ—Å—Ç—ã) ‚Üê –î–£–ë–õ–ò–ö–ê–¢ (—É–∂–µ –±—ã–ª–∏ –≤ PR)

PR –≤ main:
  ‚îú‚îÄ ci.yml (—Ç–µ—Å—Ç—ã)
  ‚îî‚îÄ test-matrix-full.yml (—Ç–µ—Å—Ç—ã) ‚Üê –î–£–ë–õ–ò–ö–ê–¢

Push –≤ main:
  ‚îú‚îÄ ci.yml (—Ç–µ—Å—Ç—ã) ‚Üê –î–£–ë–õ–ò–ö–ê–¢
  ‚îî‚îÄ deploy-prod.yml (—Ç–µ—Å—Ç—ã + –¥–µ–ø–ª–æ–π)
```

**–ü–æ—Å–ª–µ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ):**

```
PR –≤ develop:
  ‚îî‚îÄ ci.yml (–±—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã SQLite)

Push –≤ develop:
  ‚îî‚îÄ (–Ω–∏—á–µ–≥–æ - –∫–æ–¥ —É–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω)

PR –≤ main:
  ‚îî‚îÄ deploy-prod.yml (–ø–æ–ª–Ω—ã–µ —Ç–µ—Å—Ç—ã –ë–ï–ó –¥–µ–ø–ª–æ—è)

Push –≤ main:
  ‚îî‚îÄ deploy-prod.yml (–ø–æ–ª–Ω—ã–µ —Ç–µ—Å—Ç—ã + –î–ï–ü–õ–û–ô)
```

### –≠–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏:

| –°—Ü–µ–Ω–∞—Ä–∏–π       | –î–æ                   | –ü–æ—Å–ª–µ                | –≠–∫–æ–Ω–æ–º–∏—è    |
| -------------- | -------------------- | -------------------- | ----------- |
| PR –≤ develop   | ~15 –º–∏–Ω (2 workflow) | ~7 –º–∏–Ω (1 workflow)  | **-8 –º–∏–Ω**  |
| Push –≤ develop | ~7 –º–∏–Ω               | 0 –º–∏–Ω                | **-7 –º–∏–Ω**  |
| PR –≤ main      | ~20 –º–∏–Ω (3 workflow) | ~15 –º–∏–Ω (1 workflow) | **-5 –º–∏–Ω**  |
| Push –≤ main    | ~30 –º–∏–Ω (2 workflow) | ~20 –º–∏–Ω (1 workflow) | **-10 –º–∏–Ω** |

**–ò—Ç–æ–≥–æ:** –≠–∫–æ–Ω–æ–º–∏—è ~30 –º–∏–Ω—É—Ç CI/CD –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –∫–∞–∂–¥—ã–π —Ä–µ–ª–∏–∑!

## üîß –†—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã (hotfix):

```bash
# GitHub UI ‚Üí Actions ‚Üí Production Deploy Pipeline ‚Üí Run workflow
# ‚úì skip_tests: true
```

### –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é:

```bash
# GitHub UI ‚Üí Actions ‚Üí Production Deploy Pipeline ‚Üí Run workflow
# ‚úì skip_integration: true
```

### –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–ø–ª–æ–π (–Ω–∞ PR):

```bash
# GitHub UI ‚Üí Actions ‚Üí Production Deploy Pipeline ‚Üí Run workflow
# ‚úì force_deploy: true
```

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

1. **–õ–∏–Ω—Ç–∏–Ω–≥** –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ CI (Develop)
2. **–ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã** (SQLite) –¥–ª—è PR –≤ develop
3. **–ü–æ–ª–Ω—ã–µ —Ç–µ—Å—Ç—ã** (SQLite + PostgreSQL) –¥–ª—è PR/Push –≤ main
4. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã** –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –¥–µ–ø–ª–æ–µ–º
5. **PostgreSQL –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä** —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
6. **PostgreSQL –≤–Ω–µ—à–Ω—è—è** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

## üéØ Best Practices

‚úÖ **DO:**

- –°–æ–∑–¥–∞–≤–∞—Ç—å feature –≤–µ—Ç–∫–∏ –æ—Ç develop
- –î–µ–ª–∞—Ç—å PR –≤ develop –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
- –ú–µ—Ä–¥–∂–∏—Ç—å develop ‚Üí main —á–µ—Ä–µ–∑ PR
- –î–æ–∂–¥–∞—Ç—å—Å—è —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è –ø–µ—Ä–µ–¥ –Ω–æ–≤—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏

‚ùå **DON'T:**

- –ü—É—à–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é –≤ develop (–æ–±—Ö–æ–¥–∏—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏)
- –ü—É—à–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é –≤ main (–∑–∞—â–∏—â–µ–Ω–∞)
- –ü—Ä–æ–ø—É—Å–∫–∞—Ç—å —Ç–µ—Å—Ç—ã –±–µ–∑ –≤–µ—Å–∫–æ–π –ø—Ä–∏—á–∏–Ω—ã
- –î–µ–ª–∞—Ç—å force deploy –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-10-05  
**Issue:** [#17 - Docker Compose –ø—Ä–æ—Ñ–∏–ª–∏](https://github.com/Black-Cat-OSS/avatar-gen/issues/17)
