import type { Plugin } from 'vite';
import { readdirSync, statSync, readFileSync } from 'fs';
import { join, relative, sep } from 'path';

/**
 * –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –Ω–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ locales –≤ –ø—Ä–æ–µ–∫—Ç–µ
 */
function findLocalesDirectories(dir: string, results: string[] = []): string[] {
  try {
    const files = readdirSync(dir);

    for (const file of files) {
      const filePath = join(dir, file);
      const stat = statSync(filePath);

      if (stat.isDirectory()) {
        if (file === 'locales') {
          results.push(filePath);
        } else if (file !== 'node_modules' && file !== 'dist' && file !== '.git') {
          findLocalesDirectories(filePath, results);
        }
      }
    }
  } catch {
    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è–º
  }

  return results;
}

/**
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç namespace –∏–∑ –ø—É—Ç–∏ –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ locales
 */
function getNamespaceFromPath(localesPath: string, srcPath: string): string {
  const relativePath = relative(srcPath, localesPath);
  const parts = relativePath.split(sep);

  // –£–±–∏—Ä–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç (locales) –∏ shared
  const filteredParts = parts.slice(0, -1).filter(part => part !== 'shared');

  if (filteredParts.length === 0) {
    return 'translation';
  }

  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø—É—Ç—å –≤ camelCase namespace
  // –ù–∞–ø—Ä–∏–º–µ—Ä: features/avatar-link-copy -> featuresAvatarLinkCopy
  const namespace = filteredParts
    .join('-')
    .split('-')
    .map((part, index) => (index === 0 ? part : part.charAt(0).toUpperCase() + part.slice(1)))
    .join('');

  return namespace;
}

/**
 * –°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ –ø–µ—Ä–µ–≤–æ–¥—ã –∏–∑ JSON —Ñ–∞–π–ª–æ–≤
 */
function collectTranslations(localesDirs: string[], srcPath: string) {
  const translations: Record<string, Record<string, Record<string, unknown>>> = {};
  const supportedLanguages = new Set<string>();

  for (const localesDir of localesDirs) {
    const namespace = getNamespaceFromPath(localesDir, srcPath);

    try {
      const files = readdirSync(localesDir);

      for (const file of files) {
        if (file.endsWith('.json')) {
          const lang = file.replace('.json', '');
          supportedLanguages.add(lang);

          const filePath = join(localesDir, file);
          const content = readFileSync(filePath, 'utf-8');
          const data = JSON.parse(content);

          if (!translations[lang]) {
            translations[lang] = {};
          }

          translations[lang][namespace] = data;
        }
      }
    } catch (error) {
      console.error(`Error reading locales from ${localesDir}:`, error);
    }
  }

  return { translations, supportedLanguages: Array.from(supportedLanguages) };
}

/**
 * Vite –ø–ª–∞–≥–∏–Ω –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±–æ—Ä–∞ –∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤
 */
export function i18nAutoImport(): Plugin {
  const virtualModuleId = 'virtual:i18n-resources';
  const resolvedVirtualModuleId = '\0' + virtualModuleId;

  let srcPath: string;
  let generatedCode: string;

  return {
    name: 'vite-plugin-i18n-auto-import',

    configResolved(config) {
      srcPath = join(config.root, 'src');
    },

    resolveId(id) {
      if (id === virtualModuleId) {
        return resolvedVirtualModuleId;
      }
    },

    load(id) {
      if (id === resolvedVirtualModuleId) {
        if (!generatedCode) {
          const localesDirs = findLocalesDirectories(srcPath);
          const { translations, supportedLanguages } = collectTranslations(localesDirs, srcPath);

          console.log(`\nüåê i18n: –°–æ–±—Ä–∞–Ω–æ ${localesDirs.length} –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π —Å –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏`);
          console.log(`   –Ø–∑—ã–∫–∏: ${supportedLanguages.join(', ')}`);
          console.log(
            `   Namespaces: ${Object.keys(translations[supportedLanguages[0]] || {}).join(', ')}\n`,
          );

          // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥ –Ω–∞–ø—Ä—è–º—É—é –±–µ–∑ JSON.stringify
          const translationsStr = JSON.stringify(translations, null, 2);
          const languagesStr = JSON.stringify(supportedLanguages);

          generatedCode = `// Auto-generated by vite-plugin-i18n-auto-import
export const i18nResources = ${translationsStr};
export const supportedLanguages = ${languagesStr};
`;
        }

        return generatedCode;
      }
    },

    async handleHotUpdate({ file, server, modules }) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ —Ñ–∞–π–ª –ø–µ—Ä–µ–≤–æ–¥–∞
      if (file.includes('locales') && file.endsWith('.json')) {
        const fileName = file.split(/[/\\]locales[/\\]/)[1] || file;
        console.log(`\nüîÑ HMR: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –∏–∑ ${fileName}`);

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—ç—à —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞
        generatedCode = '';

        // –ü–æ–ª—É—á–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –º–æ–¥—É–ª—å
        const module = server.moduleGraph.getModuleById(resolvedVirtualModuleId);
        if (module) {
          // –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –º–æ–¥—É–ª—å
          server.moduleGraph.invalidateModule(module);

          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º HMR —Å–æ–±—ã—Ç–∏–µ –≤—Å–µ–º –∏–º–ø–æ—Ä—Ç–µ—Ä–∞–º
          const timestamp = Date.now();
          const hmrPayload = {
            type: 'update' as const,
            updates: [
              {
                type: 'js-update' as const,
                timestamp,
                path: virtualModuleId,
                acceptedPath: virtualModuleId,
              },
            ],
          };

          server.ws.send(hmrPayload);
          console.log('‚úÖ HMR: –ü–µ—Ä–µ–≤–æ–¥—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã');

          // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞—Å—Å–∏–≤ –º–æ–¥—É–ª–µ–π –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ HMR
          return [module, ...modules];
        }

        return [];
      }
    },
  };
}
