# Avatar Module

–ú–æ–¥—É–ª—å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞–º–∏ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤.

## –û–±–∑–æ—Ä

Avatar –º–æ–¥—É–ª—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∞–≤–∞—Ç–∞—Ä–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–µ —Ç–∏–ø—ã –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤:

- **Pixelize** - –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –ø–∏–∫—Å–µ–ª—å–Ω—ã–π —É–∑–æ—Ä
- **Wave** - –ø–ª–∞–≤–Ω—ã–π –≤–æ–ª–Ω–æ–≤–æ–π —É–∑–æ—Ä  
- **Gradient** - –ª–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —É–∑–æ—Ä
- **Emoji** - –∞–≤–∞—Ç–∞—Ä—ã —Å —ç–º–æ–¥–∑–∏ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ–æ–Ω–∞—Ö

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

- `AvatarController` - REST API –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
- `AvatarService` - –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞–º–∏
- `GeneratorService` - –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤
- `StorageService` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∞–≤–∞—Ç–∞—Ä–æ–≤
- `CacheService` - –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–æ–≤

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

Avatar –º–æ–¥—É–ª—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–ª–µ–¥—É—é—â–∏—Ö —Å–µ—Ä–≤–∏—Å–Ω—ã—Ö –º–æ–¥—É–ª–µ–π:

- **EmojiModule** - –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —ç–º–æ–¥–∑–∏ —á–µ—Ä–µ–∑ Twemoji CDN
  - –ü–æ–ª—É—á–µ–Ω–∏–µ SVG —ç–º–æ–¥–∑–∏
  - –†–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –≤ PNG
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ CDN
  - –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–º–æ–¥–∑–∏

### –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã

–ö–∞–∂–¥—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `IGeneratorStrategy`:

```typescript
interface IGeneratorStrategy {
  generateAvatar(
    primaryColor?: string,
    foreignColor?: string,
    colorScheme?: string,
    seed?: string,
    angle?: number
  ): Promise<AvatarObject>;
}
```

## API Endpoints

### v2/generate (Classic Generators)

–°–æ–∑–¥–∞–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏—Ö –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–≤.

**POST** `/api/v2/generate`

**Request Body:**
```json
{
  "primaryColor": "#3b82f6",
  "foreignColor": "#ef4444", 
  "colorScheme": "default",
  "seed": "unique-seed",
  "generatorType": "pixelize",
  "angle": 90
}
```

**Response:**
```json
{
  "id": "uuid",
  "createdAt": "2024-01-01T00:00:00.000Z",
  "version": 1
}
```

### v3/generate (Emoji Generator)

–°–æ–∑–¥–∞–Ω–∏–µ —ç–º–æ–¥–∑–∏-–∞–≤–∞—Ç–∞—Ä–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º —Ñ–æ–Ω–æ–º.

**POST** `/api/v3/generate`

**Request Body:**
```json
{
  "emoji": "üòÄ",
  "backgroundType": "linear",
  "primaryColor": "#3b82f6",
  "foreignColor": "#ef4444",
  "angle": 90,
  "emojiSize": "large"
}
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**

- `emoji` (string, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π) - Unicode —ç–º–æ–¥–∑–∏
- `backgroundType` (enum, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π) - –¢–∏–ø —Ñ–æ–Ω–∞: `solid`, `linear`, `radial`
- `primaryColor` (string, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π) - –û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ (hex —Ñ–æ—Ä–º–∞—Ç)
- `foreignColor` (string, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π) - –í—Ç–æ—Ä–∏—á–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–≤ (hex —Ñ–æ—Ä–º–∞—Ç)
- `angle` (number, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π) - –£–≥–æ–ª –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞ (0-360¬∞)
- `emojiSize` (enum, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π) - –†–∞–∑–º–µ—Ä —ç–º–æ–¥–∑–∏: `small`, `medium`, `large`

**Response:**
```json
{
  "id": "uuid",
  "createdAt": "2024-01-01T00:00:00.000Z", 
  "version": 1
}
```

## Emoji Generator

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç **EmojiService** –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Twemoji CDN
- –ó–∞–≥—Ä—É–∑–∫–∞ SVG —ç–º–æ–¥–∑–∏ —á–µ—Ä–µ–∑ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å
- –†–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è SVG –≤ PNG —Å –ø–æ–º–æ—â—å—é Sharp
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–æ–Ω–æ–≤ (solid/linear/radial)
- –ö–æ–º–ø–æ–∑–∏—Ü–∏—è —ç–º–æ–¥–∑–∏ –Ω–∞ —Ñ–æ–Ω —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º —Ä–∞–∑–º–µ—Ä–æ–º
- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —ç–º–æ–¥–∑–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ EmojiService

### –ü—Ä–æ—Ü–µ—Å—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ SVG** - —á–µ—Ä–µ–∑ `EmojiService.fetchEmojiSvg(emoji)`
2. **–†–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è** - —á–µ—Ä–µ–∑ `EmojiService.rasterizeEmoji(svgBuffer, options)`
3. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–æ–Ω–∞** - solid/linear/radial gradient
4. **–ö–æ–º–ø–æ–∑–∏—Ü–∏—è** - –Ω–∞–ª–æ–∂–µ–Ω–∏–µ —ç–º–æ–¥–∑–∏ –Ω–∞ —Ñ–æ–Ω —Å —É—á–µ—Ç–æ–º —Ä–∞–∑–º–µ—Ä–∞
5. **–í–æ–∑–≤—Ä–∞—Ç** - —Ñ–∏–Ω–∞–ª—å–Ω—ã–π PNG –¥–ª—è –≤—Å–µ—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ (4n-9n)

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å EmojiService

```typescript
// –í EmojiGeneratorModule
constructor(private readonly emojiService: EmojiService) {}

async generateEmojiAvatar(emoji: string) {
  // –ü–æ–ª—É—á–∏—Ç—å SVG —á–µ—Ä–µ–∑ EmojiService
  const svgBuffer = await this.emojiService.fetchEmojiSvg(emoji);
  
  // –†–∞—Å—Ç–µ—Ä–∏–∑–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ EmojiService
  const pngBuffer = await this.emojiService.rasterizeEmoji(svgBuffer, {
    width: emojiPixelSize,
    height: emojiPixelSize,
    format: 'png'
  });
  
  // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏
  return this.compositeEmojiOnBackground(backgroundBuffer, pngBuffer);
}
```

### –†–∞–∑–º–µ—Ä—ã —ç–º–æ–¥–∑–∏

- **Small** - 40% –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –∞–≤–∞—Ç–∞—Ä–∞
- **Medium** - 60% –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –∞–≤–∞—Ç–∞—Ä–∞  
- **Large** - 80% –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –∞–≤–∞—Ç–∞—Ä–∞

### –¢–∏–ø—ã —Ñ–æ–Ω–æ–≤

- **Solid** - –æ–¥–Ω–æ—Ü–≤–µ—Ç–Ω—ã–π —Ñ–æ–Ω
- **Linear** - –ª–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º —É–≥–ª–æ–º
- **Radial** - —Ä–∞–¥–∏–∞–ª—å–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç –æ—Ç —Ü–µ–Ω—Ç—Ä–∞

## Health Check

**GET** `/api/health`

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∏ –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤.

**Response:**
```json
{
  "database": 42,
  "status": "healthy",
  "services": {
    "twemoji": {
      "available": true,
      "lastChecked": "2024-01-01T00:00:00.000Z"
    }
  }
}
```

**–°—Ç–∞—Ç—É—Å—ã:**
- `healthy` - –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –¥–æ—Å—Ç—É–ø–Ω—ã
- `unhealthy` - –æ–¥–∏–Ω –∏–ª–∏ –±–æ–ª–µ–µ —Å–µ—Ä–≤–∏—Å–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å EmojiService

Health check –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `EmojiService.checkTwemojiAvailability()` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Twemoji CDN:

```typescript
// –í AvatarService
async healthCheck() {
  const dbHealth = await this.avatarRepository.count();
  const twemojiAvailable = await this.emojiService.checkTwemojiAvailability();
  
  if (!twemojiAvailable) {
    this.logger.warn('Twemoji CDN is not available - emoji avatar generation may fail');
  }
  
  return {
    database: dbHealth,
    status: dbHealth && twemojiAvailable ? 'healthy' : 'unhealthy',
    services: {
      twemoji: {
        available: twemojiAvailable,
        lastChecked: new Date(),
      },
    },
  };
}
```

## –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

### Avatar Entity

–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:

```typescript
{
  id: string,
  name: string,
  filePath: string,
  primaryColor: string,
  foreignColor: string,
  colorScheme: string,
  seed: string,
  generatorType: 'pixelize' | 'wave' | 'gradient' | 'emoji',
  createdAt: Date,
  updatedAt: Date,
  version: number
}
```

### AvatarObject

–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏:

```typescript
{
  meta_data_name: string,
  meta_data_created_at: Date,
  meta_data_payload?: Record<string, unknown>, // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞
  image_4n: Buffer,
  image_5n: Buffer,
  image_6n: Buffer,
  image_7n: Buffer,
  image_8n: Buffer,
  image_9n: Buffer
}
```

### Payload –¥–ª—è Emoji Generator

```typescript
{
  emoji: string,
  backgroundType: 'solid' | 'linear' | 'radial',
  emojiSize: 'small' | 'medium' | 'large',
  angle?: number // –¥–ª—è linear –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞
}
```

## –í–∞–ª–∏–¥–∞—Ü–∏—è

### DTO Validation

–í—Å–µ –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è —Å –ø–æ–º–æ—â—å—é `class-validator`:

- **Emoji** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–∞–ª–∏–¥–Ω—ã–π Unicode —ç–º–æ–¥–∑–∏
- **Colors** - –ø—Ä–æ–≤–µ—Ä–∫–∞ hex —Ñ–æ—Ä–º–∞—Ç–∞ (#RRGGBB)
- **Angles** - –¥–∏–∞–ø–∞–∑–æ–Ω 0-360¬∞
- **Enums** - —Ç–æ–ª—å–∫–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —ç–º–æ–¥–∑–∏: 10 —Å–∏–º–≤–æ–ª–æ–≤
- –¶–≤–µ—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ hex (#RRGGBB)
- –£–≥–ª—ã –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 0-360¬∞
- –†–∞–∑–º–µ—Ä—ã —ç–º–æ–¥–∑–∏: small/medium/large

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏

- **400 Bad Request** - –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- **500 Internal Server Error** - –æ—à–∏–±–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- **503 Service Unavailable** - –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Twemoji CDN
- –û—à–∏–±–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
- –£—Å–ø–µ—à–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å ID —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞

```bash
curl -X POST http://localhost:3000/api/v2/generate \
  -H "Content-Type: application/json" \
  -d '{
    "primaryColor": "#3b82f6",
    "foreignColor": "#ef4444",
    "generatorType": "pixelize",
    "seed": "my-unique-seed"
  }'
```

### –°–æ–∑–¥–∞–Ω–∏–µ —ç–º–æ–¥–∑–∏-–∞–≤–∞—Ç–∞—Ä–∞

```bash
curl -X POST http://localhost:3000/api/v3/generate \
  -H "Content-Type: application/json" \
  -d '{
    "emoji": "üöÄ",
    "backgroundType": "linear",
    "primaryColor": "#ff6b6b",
    "foreignColor": "#4ecdc4",
    "angle": 45,
    "emojiSize": "large"
  }'
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è

```bash
curl http://localhost:3000/api/health
```

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- `twemoji-parser` - –ø–∞—Ä—Å–∏–Ω–≥ —ç–º–æ–¥–∑–∏
- `sharp` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- `class-validator` - –≤–∞–ª–∏–¥–∞—Ü–∏—è DTO
- `class-transformer` - —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

- Health check –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è Twemoji CDN
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- –ú–µ—Ç—Ä–∏–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞–≤–∞—Ç–∞—Ä–æ–≤
- –ö–µ—à —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
